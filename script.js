const akshayDefaultStyles = {

    alignContent: 'normal',
    alignItems: 'normal',
    alignSelf: 'auto',
    alignmentBaseline: 'auto',
    all: '',
    animation: 'none 0s ease 0s 1 normal none running',
    animationDelay: '0s',
    animationDirection: 'normal',
    animationDuration: '0s',
    animationFillMode: 'none',
    animationIterationCount: '1',
    animationName: 'none',
    animationPlayState: 'running',
    animationTimingFunction: 'ease',
    appearance: 'none',
    aspectRatio: 'auto',
    backdropFilter: 'none',
    backfaceVisibility: 'visible',
    background: 'rgba(0,0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box',
    backgroundColor: "rgba(0,0, 0, 0)",
    backgroundAttachment: 'scroll',
    backgroundBlendMode: 'normal',
    backgroundClip: 'border-box',
    backgroundImage: 'none',
    backgroundRepeat: 'repeat',
    backgroundRepeatX: '',

    backgroundRepeatY: '',
    backgroundSize: 'auto',
    border: '0px none rgb(0, 0, 0)',
    borderRadius: '0px',
    bottom: 'auto',
    boxShadow: 'none',
    boxSizing: 'content-box',
    clear: 'none',
    clip: 'auto',
    clipPath: 'none',
    clipRule: 'nonzero',
    color: 'rgb(0, 0, 0)',

    columnCount: 'auto',
    columnFill: 'balance',
    columnGap: 'normal',
    columnRuleStyle: 'none',
    columnRuleWidth: '0px',
    columnSpan: 'none',
    columnWidth: 'auto',
    columns: 'auto auto',
    contain: 'none',
    content: 'normal',
    contentVisibility: 'visible',
    counterIncrement: 'none',
    counterReset: 'none',
    counterSet: 'none',
    cursor: 'auto',
    cx: '0px',
    cy: '0px',
    d: 'none',
    descentOverride: '',
    direction: 'ltr',
    display: '',
    dominantBaseline: 'auto',
    emptyCells: 'show',
    fallback: '',
    fill: 'rgb(0, 0, 0)',
    fillOpacity: '1',
    fillRule: 'nonzero',
    filter: 'none',
    flex: '0 1 auto',
    flexBasis: 'auto',
    flexDirection: 'row',
    flexFlow: 'row nowrap',
    flexGrow: '0',
    flexShrink: '1',
    flexWrap: 'nowrap',
    float: 'none',
    // font: '16px \',Times New Roman\',',
    fontDisplay: '',
    fontFamily: '\',Times New Roman\',',
    fontSize: '16px',
    fontStretch: '100%',
    fontStyle: 'normal',
    fontWeight: '400',
    gap: 'normal',
    grid: 'none / none / none / row / auto / auto',
    gridArea: 'auto / auto / auto / auto',
    gridAutoColumns: 'auto',
    gridAutoFlow: 'row',
    gridAutoRows: 'auto',
    gridColumn: 'auto / auto',
    gridColumnEnd: 'auto',
    gridColumnGap: 'normal',
    gridColumnStart: 'auto',
    gridGap: 'normal normal',
    gridRow: 'auto / auto',
    gridRowEnd: 'auto',
    gridRowGap: 'normal',
    gridRowStart: 'auto',
    gridTemplate: 'none / none / none',
    gridTemplateAreas: 'none',
    gridTemplateColumns: 'none',
    gridTemplateRows: 'none',
    height: '0px',
    imageOrientation: 'from-image',
    imageRendering: 'auto',
    justifyContent: 'normal',
    justifyItems: 'normal',
    justifySelf: 'auto',
    left: 'auto',
    letterSpacing: 'normal',
    lightingColor: 'rgb(255, 255, 255)',
    lineBreak: 'auto',
    lineGapOverride: '',
    lineHeight: 'normal',
    listStyle: 'outside none disc',
    listStyleImage: 'none',
    listStylePosition: 'outside',
    listStyleType: 'disc',
    margin: '0px',
    marker: 'none',
    markerEnd: 'none',
    markerMid: 'none',
    markerStart: 'none',
    mask: 'none',
    maskType: 'luminance',

    maxHeight: 'none',

    maxWidth: 'none',
    maxZoom: '',
    minHeight: '0px',

    minWidth: '0px',
    minZoom: '',
    mixBlendMode: 'normal',
    offset: 'none 0px auto 0deg',
    offsetDistance: '0px',
    offsetPath: 'none',
    offsetRotate: 'auto 0deg',
    opacity: '1',
    order: '0',
    orientation: '',
    orphans: '2',
    outline: 'rgb(0, 0, 0) none 0px',
    overflow: 'visible',
    overflowAnchor: 'auto',
    overflowClipMargin: '0px',
    overflowWrap: 'normal',
    overflowX: 'visible',
    overflowY: 'visible',
    overrideColors: '',
    overscrollBehavior: 'auto',
    overscrollBehaviorBlock: 'auto',
    overscrollBehaviorInline: 'auto',
    overscrollBehaviorX: 'auto',
    overscrollBehaviorY: 'auto',
    padding: '0px',
    pageOrientation: '',
    pointerEvents: 'auto',
    position: 'static',

    r: '0px',
    range: '',
    resize: 'none',
    right: 'auto',
    rotate: 'none',
    rowGap: 'normal',
    rx: 'auto',
    ry: 'auto',
    scale: 'none',
    scrollBehavior: 'auto',
    scrollMargin: '0px',
    scrollMarginBlock: '0px',
    scrollMarginBlockEnd: '0px',
    scrollMarginBlockStart: '0px',
    scrollMarginBottom: '0px',
    scrollMarginInline: '0px',
    scrollMarginInlineEnd: '0px',
    scrollMarginInlineStart: '0px',
    scrollMarginLeft: '0px',
    scrollMarginRight: '0px',
    scrollMarginTop: '0px',
    scrollPadding: 'auto',
    scrollPaddingBlock: 'auto',
    scrollPaddingBlockEnd: 'auto',
    scrollPaddingBlockStart: 'auto',
    scrollPaddingBottom: 'auto',
    scrollPaddingInline: 'auto',
    scrollPaddingInlineEnd: 'auto',
    scrollPaddingInlineStart: 'auto',
    scrollPaddingLeft: 'auto',
    scrollPaddingRight: 'auto',
    scrollPaddingTop: 'auto',
    scrollSnapAlign: 'none',
    scrollSnapStop: 'normal',
    scrollSnapType: 'none',
    scrollbarGutter: 'auto',
    shapeImageThreshold: '0',
    shapeMargin: '0px',
    shapeOutside: 'none',
    shapeRendering: 'auto',
    size: '',
    src: '',
    stopColor: 'rgb(0, 0, 0)',
    stopOpacity: '1',
    stroke: 'none',
    strokeOpacity: '1',
    strokeWidth: '1px',
    suffix: '',
    symbols: '',
    syntax: '',
    system: '',
    tabSize: '8',
    tableLayout: 'auto',
    textAlign: 'start',
    textAlignLast: 'auto',
    textAnchor: 'start',
    textCombineUpright: 'none',
    textDecoration: 'none solid rgb(0, 0, 0)',
    textIndent: '0px',
    textOrientation: 'mixed',
    textOverflow: 'clip',
    textShadow: 'none',
    textTransform: 'none',
    top: 'auto',
    transform: 'none',
    transition: 'all 0s ease 0s',
    transitionDelay: '0s',
    transitionDuration: '0s',
    transitionProperty: 'all',
    transitionTimingFunction: 'ease',
    translate: 'none',
    userZoom: '',
    verticalAlign: 'baseline',
    visibility: 'visible',
    whiteSpace: 'normal',
    width: '0px',
    wordBreak: 'normal',
    wordSpacing: '0px',
    wordWrap: 'normal',
    x: '0px',
    y: '0px',
    zIndex: 'auto',
    zoom: '1',
}

///////////////////// UTILITY FUNCTIONS //////////////////////////////////////////////
function icssSendAlert(message) {
    const icssAlertBox = document.querySelector(".icssAlertBox")
    icssAlertBox.textContent = message
    icssAlertBox.style.backgroundColor = "#d94e4e"
    setTimeout(() => {
        icssAlertBox.style.backgroundColor = "#2b343b"
        icssAlertBox.textContent = "Press alt + s to start or stop the CSS Scan. Click outside the box to pause or resume the scan."
    }, 2000)
}

function createUniqueSelector(element) {
    const attributes = element.getAttributeNames()
    let selector = `${element.tagName.toLowerCase()}`
    for (let attr of attributes) {
        if (attr === 'class') {
            let classNames = element.getAttribute(attr).split(" ")
            if (!classNames && element.getAttribute("id")) {
                selector += `#${element.getAttribute("id")}`
            } else {
                for (let className of classNames) {
                    selector += `.${className}`
                }
            }

        }
    }
    return selector
}

function normalizeCssPropName(name) {
    let s = ""
    let s1 = name.toLowerCase()
    for (let x = 0; x < name.length; x++) {
        if (s1[x].toUpperCase() === name[x]) {

            s += "-" + s1[x]
        } else {
            s += s1[x]
        }
    }
    return s
}

function cssPropsToHTML(cssProps) {
    let priorityProps = ['display', "color", 'border-radius', 'position', 'font-weight', 'background-color', 'margin', 'padding', 'width', 'height', 'font-size', 'max-width']
    let propertyColor = 'rgb(3, 218, 198)'
    let valueColor = 'white'
    let priorityCSSText = ''
    let normalCSSText = ""
    for (let prop in cssProps) {
        let normalizedName = normalizeCssPropName(prop)
        if (priorityProps.includes(normalizedName)) {
            priorityCSSText += `
            <div class='icssExcluded' style='margin: 3px 5px;'><span class='icssExcluded' style='color : ${propertyColor};'>${normalizedName}</span> : <span class='icssExcluded' style='color : ${valueColor};'>${cssProps[prop]} ;<span></div>`
        } else {
            normalCSSText += `
            <div class='icssExcluded' style='margin: 3px 5px;'><span class='icssExcluded' style='color : ${propertyColor};'>${normalizedName}</span> : <span class='icssExcluded' style='color : ${valueColor};'>${cssProps[prop]} ;<span></div>`
        }

    }
    return { priorityCSSText, normalCSSText }
}

function getCssProps(element) {
    const computedProps = {}

    const computedStyles = window.getComputedStyle(element)


    for (let key in computedStyles) {
        if (key in akshayDefaultStyles && computedStyles[key] !== akshayDefaultStyles[key]) {
            computedProps[key] = computedStyles[key]
        }
    }
    return computedProps
}

function stringifyCSS(cssProps) {
    let allProps = cssProps
    let s = "{\n"
    for (let prop in allProps) {
        s += `  ${normalizeCssPropName(prop)} : ${allProps[prop]};\n`
    }
    return s + "}\n"
}

//////////// CREATING UI /////////////////////////////////////////////////////

function createCssCodeContainer() {
    const body = document.querySelector('body')
    body.style.position = 'relative'


    // WRAPPER
    const wrapper = document.createElement("div")
    wrapper.classList.add("icssWrapper")
    wrapper.classList.add("icssExcluded")
    wrapper.innerHTML = `
    <div class='icssContainer icssExcluded'>
        <div class="icssCodeContainer icssExcluded">
    
        </div>
        <div class="icssNavbar icssExcluded">
            <button class="icssFuncBtn icssCopyBtn icssExcluded">
                Copy
            </button>
            <button class="icssFuncBtn icssCopyAllBtn icssExcluded">
                Copy All
            </button>
            <a href='https://github.com/akshaymalik1995/css-inspector/issues' target='_blank' class="icssFuncBtn icssReportBugBtn icssExcluded"> Report Bug
            </a>
            <button class="icssFuncBtn icssColorBtn icssExcluded">
            </button>
            <button class="icssFuncBtn icssBgColorBtn icssExcluded">
            </button>
            
        </div>
    </div>
    
    <form class="editCSSForm icssExcluded">
    <input type="search" autofocus autocomplete='off' placeholder="Edit CSS here => property : value;" class="icssEditInput icssExcluded" name="newCssRule" />
    </form>

    <div class="icssAlertBox icssExcluded"> Press alt + s to start or stop the CSS Scan. Click outside the box to pause or resume the scan. </div>
    
   
        
    `
    body.appendChild(wrapper)
    document.querySelector(".icssCopyBtn").addEventListener("click", copyBtnAddEventListener)
    document.querySelector(".icssCopyAllBtn").addEventListener("click", copyAllBtnEventListener)
    document.querySelector(".icssColorBtn").addEventListener("click", icssCopyColor)
    document.querySelector(".icssBgColorBtn").addEventListener("click", icssCopyBgColor)
    document.querySelectorAll(".icssWrapper *").forEach(element => {
        element.addEventListener("click", (event) => {
            event.stopPropagation()
        })
    })
    document.querySelector(".editCSSForm").addEventListener("submit", editCSSListener)
}

function editCSSListener(event) {
    event.preventDefault()
    let input = document.querySelector(".editCSSForm")['newCssRule'].value
    input = input.replaceAll("\n", "")
    let uniqueSelector = createUniqueSelector(elementOnTarget)
    if (uniqueSelector.includes(".")) {
        const elements = document.querySelectorAll(`${uniqueSelector}:not(.icssExcluded)`)
        elements.forEach(element => {
            element.style.cssText += input.trim()
        })
    } else {
        elementOnTarget.style.cssText += input.trim()
    }
    
}

function mouseOverListener(event) {
    event.preventDefault()
    event.stopPropagation();
    elementOnTarget = event.target
    if (!event.target.classList.contains("icssExcluded")) {
        document.querySelector(".icssColorBtn").style.backgroundColor = window.getComputedStyle(elementOnTarget).getPropertyValue("color")
        document.querySelector(".icssBgColorBtn").style.backgroundColor = window.getComputedStyle(elementOnTarget).getPropertyValue("background-color")
        oldBorderProperty = window.getComputedStyle(elementOnTarget).getPropertyValue("border")

        let uniqueSelector = createUniqueSelector(event.target)
        let computedProps = getCssProps(event.target)
        let cssText = cssPropsToHTML(computedProps)
        console.log(cssText.priorityCSSText)
        document.querySelector(".icssCodeContainer").innerHTML = `<span class='icssExcluded' style='color:rgb(255, 90, 95);'>${uniqueSelector}</span><br>${cssText.priorityCSSText}<hr>${cssText.normalCSSText}<br>`
        event.target.style.outline = "2px red dashed"


    }
}

function mouseOutListener(event) {

    event.stopPropagation();
    if (elementOnTarget) {
        elementOnTarget.style.outline = 'none'
    }
    event.target.style.outline = 'none'

}

function copyBtnAddEventListener(event) {
    event.preventDefault()
    event.stopPropagation()
    let element = elementOnTarget
    let uniqueParentSelector = createUniqueSelector(element)
    let parentProps = getCssProps(element)
    let codeToCopy = `${uniqueParentSelector} ${stringifyCSS(parentProps)}`
    navigator.clipboard.writeText(codeToCopy)
    icssSendAlert("You have copied the CSS properties of the element")
}

function icssCopyColor(event) {
    event.preventDefault()
    event.stopPropagation()

    navigator.clipboard.writeText(event.target.style.backgroundColor)
    icssSendAlert("You have copied the text color.")
}

function icssCopyBgColor(event) {
    event.preventDefault()
    event.stopPropagation()
    navigator.clipboard.writeText(event.target.style.backgroundColor)
    icssSendAlert("You have copied the background color of the element.")
}

function copyAllBtnEventListener(event) {
    event.preventDefault()
    event.stopPropagation()
    let element = elementOnTarget
    let uniqueParentSelector = createUniqueSelector(element)
    let parentProps = getCssProps(element)

    let children = document.querySelectorAll(`${uniqueParentSelector} *`)
    let allProps = {}
    allProps[uniqueParentSelector] = parentProps
    let codeToCopy = ""
    children.forEach(child => {
        let childSelector = createUniqueSelector(child)
        let childProps = getCssProps(child)
        allProps[childSelector] = childProps
    })
    for (prop in allProps) {
        codeToCopy += `${prop} ${stringifyCSS(allProps[prop])}\n`
    }
    navigator.clipboard.writeText(codeToCopy)
    icssSendAlert("You have copied the CSS properties of the element as well of its children.")
}




function mouseMoveListener(event) {
    const cssCodeContainer = document.querySelector(".icssWrapper")
    let xPos = event.clientX
    let yPos = event.clientY
    let screenWidth = screen.width
    let sceenHeight = screen.height
    if (screenWidth - xPos > 500) {
        cssCodeContainer.style.left = `${xPos + 40}px`

    } else {
        cssCodeContainer.style.left = `${xPos - 500}px`
    }

    if (sceenHeight - yPos > 600) {
        cssCodeContainer.style.top = `${yPos + 40}px`
    } else {
        cssCodeContainer.style.top = `${yPos - 400}px`
    }

}




function toggleInspection(event) {
    event.preventDefault()
    event.stopPropagation()
    const cssCodeContainer = document.querySelector(".icssContainer")
    if (!isInspectionPaused && inspectionOn) {
        cssCodeContainer.scrollTop = 0
        allElements.forEach(element => {
            element.removeEventListener("mouseover", mouseOverListener)
            element.removeEventListener("mouseout", mouseOutListener)
            element.removeEventListener("mousemove", mouseMoveListener)
        })
        isInspectionPaused = true
        icssSendAlert("CSS Scan is paused")
    }
    else {
        cssCodeContainer.scrollTop = 0
        allElements.forEach(element => {
            element.style.outline = 'none'
            element.addEventListener("mouseover", mouseOverListener)
            element.addEventListener("mouseout", mouseOutListener)
            element.addEventListener("mousemove", mouseMoveListener)
        })
        isInspectionPaused = false
        icssSendAlert("CSS Scan is resumed")
    }
}

function turnOnInspection() {
    const cssCodeContainer = document.querySelector(".icssWrapper")
    allElements.forEach(element => {
        element.addEventListener("mouseover", mouseOverListener)
        element.addEventListener("mouseout", mouseOutListener)
        element.addEventListener("click", toggleInspection)
        element.addEventListener("mousemove", mouseMoveListener)

    })
    cssCodeContainer.style.display = 'flex'
    inspectionOn = true
    cssCodeContainer.scrollTop = 0
}
function keyBindings() {
    allElements.forEach(element => {
        element.addEventListener("keydown", (event) => {
            event.stopPropagation()
            if (event.altKey && event.keyCode === 83) {
                if (inspectionOn) {
                    turnOffInspection()
                }
                else {
                    turnOnInspection()
                }
            }
        })
    })

}



function turnOffInspection() {
    const cssCodeContainer = document.querySelector(".icssWrapper")
    allElements.forEach(element => {
        element.removeEventListener("mouseover", mouseOverListener)
        element.removeEventListener("mouseout", mouseOutListener)
        element.removeEventListener("click", toggleInspection)
        element.removeEventListener("mousemove", mouseMoveListener)
        element.style.outline = 'none'
    })
    cssCodeContainer.style.display = 'none'
    cssCodeContainer.scrollTop = 0
    inspectionOn = false
}

const allElements = document.querySelectorAll("*:not(.icssExcluded)")
let inspectionOn = false
let isInspectionPaused = false
let elementOnTarget
let oldBorderProperty = ""
createCssCodeContainer()
// turnOnInspection()
keyBindings()









